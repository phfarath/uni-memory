# Smart Memory Triggers

> **Versão Target:** V1.0
> **Status:** ⏳ Pendente
> **Owner:** Unassigned
> **Estimativa:** 40h

---

## Descrição

### Problema
Sistema atual espera que usuário explicitamente peça recall de memórias. Isso gera fricção e oportunidades perdidas:
- Usuário faz pergunta que seria respondida por contexto histórico, mas não pede recall
- AI não sabe quando memórias seriam relevantes
- Experiência parece "burra" - AI não demonstra continuidade

### Solução
Implementar sistema proativo que **detecta automaticamente quando recall seria útil** analisando mensagens do usuário.

**Técnicas:**
1. **Pattern Matching** - Regex para perguntas típicas ("qual era", "como eu fiz", "onde está")
2. **ML Classifier** - Modelo treinado para detectar intenção de recall (85%+ accuracy)
3. **Context Loss Detection** - Identifica quando usuário retoma trabalho após pausa

**Fluxo:**
```
User: "Qual era meu café favorito mesmo?"
    ↓
[Smart Trigger detecta: pergunta sobre preferência passada]
    ↓
Auto-inject recall sem user pedir
    ↓
Claude: "Seu café favorito é cappuccino!" (baseado em memória)
```

### Valor
✅ **UX "mágica"** - AI antecipa necessidades
✅ **85% accuracy** - Benchmark do MCP Memory Service
✅ **Zero fricção** - Usuário não precisa lembrar de pedir recall

---

## Passos de Implementação

### 1. Código (25h)
- [ ] Criar `app/triggers.py` com classe `SmartTriggerEngine`
- [ ] Implementar regex patterns para perguntas comuns:
  ```python
  QUESTION_PATTERNS = [
      r"qual (era|foi|é)",
      r"como (eu|fiz|fazer)",
      r"onde (está|fica|guardei)",
      r"quando (foi|aconteceu)",
      r"quem (é|foi|trabalha)",
      r"lembro",
      r"voltando (ao|para|no)",
      r"retomando"
  ]
  ```
- [ ] Implementar `should_trigger_recall(message: str) -> bool`
- [ ] Integrar no fluxo de `/v1/chat/completions`:
  ```python
  if smart_trigger.should_trigger_recall(user_message):
      context = retrieve_context_logic(session_id, user_message)
      # Inject context automaticamente
  ```
- [ ] Adicionar configuração para ativar/desativar por sessão
- [ ] Rate limiting: max 10 auto-triggers por minuto (prevenir spam)

### 2. Testes (8h)
- [ ] Test: Detecção de perguntas sobre passado
- [ ] Test: Detecção de retomada de trabalho
- [ ] Test: False positives (não trigger em mensagens normais)
- [ ] Test: Rate limiting de auto-triggers
- [ ] Test: Toggle on/off por sessão

### 3. Documentação (5h)
- [ ] `ARCHITECTURE.md`: Adicionar seção Smart Triggers
- [ ] `app/README.md`: Documentar SmartTriggerEngine
- [ ] Docstrings completos

### 4. Infraestrutura (2h)
- [ ] Adicionar config `SMART_TRIGGERS_ENABLED` em .env
- [ ] Metrics: Log quantos triggers automáticos acontecem por hora

---

## Dependências
Nenhuma - pode rodar independentemente.

---

## Referências
- [MCP Memory Service Triggers](https://github.com/doobidoo/mcp-memory-service) - 85% accuracy benchmark
- [Pattern Matching Best Practices](https://docs.python.org/3/library/re.html)

---

**Versão do documento:** 1.0
**Última atualização:** 2026-02-03
