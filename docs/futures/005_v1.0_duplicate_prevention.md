# Duplicate Prevention

> **Versão Target:** V1.0
> **Status:** ⏳ Pendente
> **Owner:** Unassigned
> **Estimativa:** 20h

---

## Descrição

### Problema
Usuários podem acidentalmente salvar a mesma informação múltiplas vezes:
- "Meu café favorito é cappuccino" (3x salvo)
- Poluição do banco de dados
- Queries retornam resultados duplicados
- Desperdício de storage e embeddings

### Solução
Verificar se memória similar já existe antes de salvar (threshold de similaridade 0.95).

**Fluxo:**
```
User: remember("Meu café favorito é cappuccino")
    ↓
[Check: Existe memória similar?]
    ↓
SIM: similarity = 0.98 com memória existente
    ↓
Warning: "Memória similar já existe. Confirmar gravação?"
    ↓
Se confirmado: Merge (atualizar timestamp)
```

### Valor
✅ **Reduz poluição** do database
✅ **Melhora qualidade** de recall (menos ruído)
✅ **Economia de storage** (~5-10% de todas memórias são duplicatas)

---

## Passos de Implementação

### 1. Código (12h)
- [ ] Criar função `check_duplicate(content: str, session_id: str) -> Optional[int]`:
  ```python
  def check_duplicate(content, session_id, threshold=0.95):
      new_embedding = embed_model.encode([content])[0]

      # Buscar memórias muito similares
      conn = get_db_connection()
      c = conn.cursor()
      c.execute("""
          SELECT id, content, (embedding <=> %s) as distance
          FROM memories
          WHERE session_id = %s
          ORDER BY distance ASC
          LIMIT 1
      """, (new_embedding, session_id))

      result = c.fetchone()
      conn.close()

      if result and (1 - result[2]) > threshold:  # Cosine similarity
          return result[0]  # Duplicate found
      return None
  ```

- [ ] Modificar `add_memory_trace_logic()` para checar antes de inserir
- [ ] Adicionar endpoint `POST /v1/memories/check-duplicate` para UI
- [ ] Implementar merge de memórias (update timestamp, manter mais recente)
- [ ] MCP tool `remember` com parâmetro `force: bool` para sobrescrever

### 2. Testes (5h)
- [ ] Test: Detectar duplicata exata (similarity 1.0)
- [ ] Test: Detectar duplicata similar (similarity 0.97)
- [ ] Test: Não bloquear memória diferente (similarity 0.60)
- [ ] Test: Merge de memórias duplicadas
- [ ] Test: Force override de detecção

### 3. Documentação (2h)
- [ ] `AI_INSTRUCTIONS.md`: Documentar lógica de deduplicação
- [ ] Docstrings para `check_duplicate()`

### 4. Infraestrutura (1h)
- [ ] Adicionar índice para busca rápida de duplicatas
- [ ] Cleanup job: Detectar e mesclar duplicatas antigas

---

## Dependências
Nenhuma

---

## Referências
- [MCP Memory Service Deduplication](https://github.com/doobidoo/mcp-memory-service)
- [Cosine Similarity](https://en.wikipedia.org/wiki/Cosine_similarity)

---

**Versão do documento:** 1.0
**Última atualização:** 2026-02-03
