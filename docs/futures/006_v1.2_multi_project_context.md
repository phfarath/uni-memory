# Multi-Project Context

> **Versão Target:** V1.2
> **Status:** ⏳ Pendente
> **Owner:** Unassigned
> **Estimativa:** 40h

---

## Descrição

### Problema
Atualmente `session_id` é genérico - não há conceito de "projeto" ou "workspace":
- Usuário trabalhando em múltiplos projetos mistura contextos
- Memórias de "Projeto A" contaminam queries sobre "Projeto B"
- Não há isolamento lógico para B2B (times, workspaces)

**Exemplo:**
```
Memórias misturadas:
- "Projeto X usa Python" (session_id: "user-123")
- "Projeto Y usa Go" (session_id: "user-123")

Query: "Qual linguagem usar?"
→ Resposta ambígua (mistura X e Y)
```

### Solução
Adicionar hierarquia: **workspace → project → session**

**Modelo de dados:**
```
workspaces (multi-tenant por empresa)
  └── projects (repos, sistemas)
      └── sessions (conversas específicas)
          └── memories
```

**Fluxo:**
```
User: switch_project("Projeto X")
→ Contexto isolado para Projeto X

Query: "Qual linguagem usar?"
→ Busca apenas em memories WHERE project_id = X
→ Resposta: "Python" (sem contaminação do Projeto Y)
```

### Valor
✅ **Isolamento cross-project** - Trabalhar em múltiplos projetos sem contaminação
✅ **B2B ready** - Billing e permissões por workspace
✅ **Melhor organização** - Memórias estruturadas hierarquicamente

---

## Passos de Implementação

### 1. Código (25h)
- [ ] Criar tabela `workspaces`:
  ```sql
  CREATE TABLE workspaces (
      id SERIAL PRIMARY KEY,
      api_key TEXT REFERENCES api_keys(key),
      name TEXT NOT NULL,
      created_at TIMESTAMPTZ DEFAULT NOW()
  );
  ```

- [ ] Criar tabela `projects`:
  ```sql
  CREATE TABLE projects (
      id SERIAL PRIMARY KEY,
      workspace_id INT REFERENCES workspaces(id),
      name TEXT NOT NULL,
      repo_url TEXT,
      metadata JSONB,
      created_at TIMESTAMPTZ DEFAULT NOW()
  );
  ```

- [ ] Adicionar FK em `memories`:
  ```sql
  ALTER TABLE memories ADD COLUMN project_id INT REFERENCES projects(id);
  CREATE INDEX idx_memories_project ON memories(project_id);
  ```

- [ ] MCP tools:
  - `switch_project(project_name: str)` - Muda contexto ativo
  - `list_projects()` - Lista projetos do workspace
  - `create_project(name: str, repo_url: str)`

- [ ] Modificar queries para filtrar por `project_id` quando definido

### 2. Testes (8h)
- [ ] Test: Criação de workspace e projects
- [ ] Test: Switch de projeto
- [ ] Test: Isolamento de memórias por projeto
- [ ] Test: List projects
- [ ] Test: Cross-project query (opcional via flag)

### 3. Documentação (5h)
- [ ] `ARCHITECTURE.md`: Adicionar seção Multi-Project com diagrama ER
- [ ] `app/README.md`: Documentar hierarquia workspace/project/session

### 4. Infraestrutura (2h)
- [ ] Migration para tabelas workspaces e projects
- [ ] Backfill: Criar workspace "default" para usuários existentes

---

## Dependências
Nenhuma

---

## Referências
- [Multi-Tenancy Best Practices](https://docs.microsoft.com/en-us/azure/architecture/guide/multitenant/overview)

---

**Versão do documento:** 1.0
**Última atualização:** 2026-02-03
