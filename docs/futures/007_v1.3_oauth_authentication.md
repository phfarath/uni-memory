# OAuth 2.1 Authentication

> **Versão Target:** V1.3
> **Status:** ⏳ Pendente
> **Owner:** Unassigned
> **Estimativa:** 60h

---

## Descrição

### Problema
Sistema atual usa apenas API keys estáticas:
- Menos seguro que OAuth para produção enterprise
- Sem suporte a refresh tokens
- Não atende compliance SOC2/ISO27001
- Dificulta integração com SSO corporativo

**MCP Best Practice 2026:** OAuth 2.1 é padrão recomendado.

### Solução
Adicionar **OAuth 2.1** como método de autenticação primário, mantendo API keys como fallback.

**Providers suportados:**
- Auth0
- Clerk
- AWS Cognito
- Self-hosted (Keycloak)

**Fluxo:**
```
User: Login via OAuth provider
    ↓
[Authorization Code Flow]
    ↓
JWT token gerado
    ↓
Requests usam Bearer token
    ↓
Middleware valida JWT em cada request
```

### Valor
✅ **Compliance enterprise** - SOC2, ISO27001
✅ **Segurança** - Refresh tokens, scopes, expiration
✅ **SSO** - Integração com Google, Microsoft, Okta

---

## Passos de Implementação

### 1. Código (40h)
- [ ] Escolher provider (Auth0 recomendado)
- [ ] Instalar dependências: `pip install authlib`
- [ ] Criar endpoint `POST /token` para login:
  ```python
  from authlib.integrations.starlette_client import OAuth

  oauth = OAuth()
  oauth.register(
      name='auth0',
      client_id=AUTH0_CLIENT_ID,
      client_secret=AUTH0_CLIENT_SECRET,
      server_metadata_url=f'https://{AUTH0_DOMAIN}/.well-known/openid-configuration',
      client_kwargs={'scope': 'openid profile email'}
  )
  ```

- [ ] Implementar middleware para validação JWT:
  ```python
  from authlib.jose import jwt

  async def verify_jwt_token(authorization: str = Header(None)):
      if not authorization:
          raise HTTPException(401, "Missing token")

      token = authorization.replace("Bearer ", "")
      claims = jwt.decode(token, AUTH0_PUBLIC_KEY)

      # Validate claims (exp, aud, iss)
      return claims
  ```

- [ ] Dual auth: OAuth OR API keys (prioridade OAuth)
- [ ] Migrar tabela `api_keys` para incluir `oauth_sub` (subject ID)

### 2. Testes (12h)
- [ ] Test: Login flow completo
- [ ] Test: JWT validation
- [ ] Test: Token expiration handling
- [ ] Test: Refresh token flow
- [ ] Test: Fallback para API keys

### 3. Documentação (6h)
- [ ] Guia de setup OAuth no README
- [ ] Documentar fluxo de autenticação em ARCHITECTURE.md

### 4. Infraestrutura (2h)
- [ ] Configurar Auth0 tenant
- [ ] Variáveis de ambiente para OAuth config

---

## Dependências
Nenhuma

---

## Referências
- [MCP OAuth Best Practices 2026](https://www.cdata.com/blog/mcp-server-best-practices-2026)
- [Auth0 Documentation](https://auth0.com/docs)
- [OAuth 2.1 Spec](https://datatracker.ietf.org/doc/html/draft-ietf-oauth-v2-1-07)

---

**Versão do documento:** 1.0
**Última atualização:** 2026-02-03
